# Post-Release Postmortem Analysis
# åœ¨å‘å¸ƒåè‡ªåŠ¨åˆ†æ fix commits å¹¶ç”Ÿæˆ Postmortem æŠ¥å‘Š
#
# ä½¿ç”¨æ–¹æ³•:
# 1. å°†æ­¤æ–‡ä»¶å¤åˆ¶åˆ°ä½ çš„é¡¹ç›® .github/workflows/ ç›®å½•
# 2. ç¡®ä¿é¡¹ç›®å·²å®‰è£… ccjk
# 3. é…ç½® GITHUB_TOKEN æƒé™å…è®¸æ¨é€

name: Post-Release Postmortem Analysis

on:
  release:
    types: [published]

  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: ç‰ˆæœ¬å· (ä¾‹å¦‚ v2.3.0)
        required: true
      since:
        description: èµ·å§‹ç‰ˆæœ¬/æ ‡ç­¾ (ä¾‹å¦‚ v2.2.0)
        required: false

jobs:
  generate-postmortem:
    name: ğŸ“ Generate Postmortem
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ“¥ Install dependencies
        run: pnpm install

      - name: ğŸ” Determine version info
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            # è·å–ä¸Šä¸€ä¸ª release ä½œä¸º since
            SINCE=$(git describe --tags --abbrev=0 ${VERSION}^ 2>/dev/null || echo "")
          else
            VERSION="${{ github.event.inputs.version }}"
            SINCE="${{ github.event.inputs.since }}"
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "since=${SINCE}" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ Version: ${VERSION}"
          echo "ğŸ“¦ Since: ${SINCE}"

      - name: ğŸ“ Generate Postmortem Report
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SINCE="${{ steps.version.outputs.since }}"

          echo "ğŸ”¬ Analyzing fix commits..."

          if [ -n "$SINCE" ]; then
            npx ccjk postmortem generate --version "$VERSION" --since "$SINCE"
          else
            npx ccjk postmortem generate --version "$VERSION"
          fi

      - name: ğŸ“Š Show Statistics
        run: |
          npx ccjk postmortem stats

      - name: ğŸ”„ Sync to CLAUDE.md
        run: |
          npx ccjk postmortem sync

      - name: ğŸ“¤ Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet ./postmortem/ CLAUDE.md 2>/dev/null; then
            echo "ğŸ“­ No changes to commit"
          else
            git add ./postmortem/ CLAUDE.md
            git commit -m "docs(postmortem): add analysis for ${{ steps.version.outputs.version }}

            - Analyzed fix commits since ${{ steps.version.outputs.since }}
            - Generated new postmortem reports
            - Synced to CLAUDE.md

            [skip ci]"

            git push
            echo "âœ… Changes committed and pushed"
          fi

      - name: ğŸ“‹ Create Summary
        run: |
          echo "## ğŸ”¬ Postmortem Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Since:** ${{ steps.version.outputs.since }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Statistics" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          npx ccjk postmortem stats >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # å¯é€‰ï¼šåˆ›å»º PR è€Œä¸æ˜¯ç›´æ¥æ¨é€
  create-pr:
    name: ğŸ“ Create PR (Alternative)
    runs-on: ubuntu-latest
    if: false # é»˜è®¤ç¦ç”¨ï¼Œå¦‚éœ€ä½¿ç”¨è¯·æ”¹ä¸º true

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ“¥ Install dependencies
        run: pnpm install

      - name: ğŸ“ Generate Postmortem
        run: |
          npx ccjk postmortem generate --version "${{ github.event.release.tag_name }}"
          npx ccjk postmortem sync

      - name: ğŸ“¤ Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'docs(postmortem): add analysis for ${{ github.event.release.tag_name }}'
          title: 'ğŸ“ Postmortem Analysis for ${{ github.event.release.tag_name }}'
          body: |
            ## ğŸ”¬ Postmortem Analysis

            This PR contains the postmortem analysis for release **${{ github.event.release.tag_name }}**.

            ### Changes
            - New postmortem reports in `./postmortem/`
            - Updated `CLAUDE.md` with latest warnings

            ### Review
            Please review the generated reports and merge if they look correct.

            ---
            *Auto-generated by CCJK Postmortem System*
          branch: postmortem/${{ github.event.release.tag_name }}
          delete-branch: true
