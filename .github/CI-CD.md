# GitHub Actions CI/CD Pipeline

## Overview

This repository uses GitHub Actions for continuous integration, deployment, and quality assurance. The pipeline is designed to complete in under 5 minutes with parallel execution and caching.

## Workflows

### 1. **CI** (`ci.yml`)
**Trigger**: Push to main/develop, Pull Requests

**Jobs**:
- `lint`: ESLint code quality checks
- `typecheck`: TypeScript type checking
- `test-unit`: Unit tests with coverage
- `test-integration`: Integration tests with PostgreSQL, Redis
- `coverage`: Combined coverage reporting
- `build`: Build validation

**Services**:
- PostgreSQL 16 (test database)
- Redis 7 (caching)
- Elasticsearch (optional)

### 2. **CD** (`cd.yml`)
**Trigger**: Push to main, Manual dispatch

**Environments**:
- `staging`: Automatic on push to main
- `production`: On release publish
- `rollback`: Manual rollback capability

### 3. **Release** (`release.yml`)
**Trigger**: Push to main with changesets, Manual

**Features**:
- Automatic version bumping via Changesets
- GitHub Release creation
- npm package publishing
- Changelog generation
- Slack notifications

### 4. **Docker** (`docker.yml`)
**Trigger**: Push, Tags, Pull Requests

**Platforms**:
- linux/amd64
- linux/arm64

**Tags**:
- `latest` (main branch)
- `v*.*.*` (version tags)
- `main-*` (branch-specific)

**Features**:
- Multi-platform builds
- Docker Hub publishing
- Trivy vulnerability scanning
- Image testing

### 5. **Benchmark** (`benchmark.yml`)
**Trigger**: Push, PRs, Daily at 2 AM UTC

**Features**:
- Performance regression detection
- Historical comparison
- PR comments with results
- 120% alert threshold

### 6. **Code Quality** (`code-quality.yml`)
**Trigger**: Push, PRs, Weekly (Sunday midnight)

**Checks**:
- ESLint with PR review annotations
- Prettier format checking
- pnpm audit (security)
- Snyk security scanning
- CodeQL analysis
- Dependency review
- Complexity analysis
- Duplicate code detection
- SonarCloud integration

### 7. **Dependency Update** (`dependency-update.yml`)
**Trigger**: Every Monday at 9 AM UTC, Manual

**Features**:
- Automatic dependency updates
- PR creation with updates
- Test validation before PR
- Automated deduplication

### 8. **Status Check** (`status-check.yml`)
**Trigger**: Push, PRs

**Quick Checks**:
- Build validation
- Quick test suite
- Package size monitoring
- catalog: reference validation

## Configuration

### Required Secrets

Add these secrets in GitHub Repository Settings:

| Secret | Description | Required For |
|--------|-------------|--------------|
| `NPM_TOKEN` | npm authentication token | Release workflow |
| `DOCKER_USERNAME` | Docker Hub username | Docker workflow |
| `DOCKER_PASSWORD` | Docker Hub password/token | Docker workflow |
| `CODECOV_TOKEN` | Codecov token | CI workflow |
| `SLACK_WEBHOOK` | Slack webhook URL | Notifications |
| `SNYK_TOKEN` | Snyk authentication token | Code quality |
| `SONAR_TOKEN` | SonarCloud token | Code quality |
| `GITHUB_TOKEN` | Auto-generated by GitHub | All workflows |

### Environment Variables

Set in GitHub Environment Settings:

**Production**:
```yaml
NODE_ENV: production
DEPLOY_URL: https://ccjk.dev
```

**Staging**:
```yaml
NODE_ENV: staging
DEPLOY_URL: https://staging.ccjk.dev
```

## Performance Optimization

### Caching Strategy

```yaml
- uses: actions/setup-node@v4
  with:
    cache: 'pnpm'  # Caches node_modules
```

```yaml
- uses: docker/build-push-action@v5
  with:
    cache-from: type=gha
    cache-to: type=gha,mode=max  # Caches Docker layers
```

### Parallel Execution

Most jobs run in parallel:
- lint, typecheck, test-unit: ~2 minutes
- test-integration: ~3 minutes (with services)
- build: ~1 minute
- Total: < 5 minutes

### Concurrency Control

```yaml
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true  # Cancel old runs on new commits
```

## Workflow Status Badges

Add to README.md:

```markdown
![CI](https://github.com/lu/ccjk-public/workflows/CI/badge.svg)
![CD](https://github.com/lu/ccjk-public/workflows/CD/badge.svg)
![Release](https://github.com/lu/ccjk-public/workflows/Release/badge.svg)
![Docker](https://github.com/lu/ccjk-public/workflows/Docker/badge.svg)
![Code Quality](https://github.com/lu/ccjk-public/workflows/Code%20Quality/badge.svg)
```

## Usage Examples

### Triggering Workflows

```bash
# Manual workflow dispatch
gh workflow run "CI"
gh workflow run "Release"
gh workflow run "Docker"
```

### Viewing Workflow Runs

```bash
# List workflow runs
gh run list --workflow=ci.yml

# View specific run
gh run view <run-id>

# View logs
gh run view <run-id> --log
```

### Re-running Failed Workflows

```bash
# Re-run failed jobs
gh run rerun <run-id>

# Re-run all jobs
gh run rerun <run-id> --failed
```

## Release Process

1. **Create changeset**:
   ```bash
   pnpm changeset
   ```

2. **Commit changeset**:
   ```bash
   git add .changeset/*.md
   git commit -m "chore: add changeset"
   git push
   ```

3. **Release workflow**:
   - Creates version PR
   - Merge version PR
   - Publishes to npm
   - Creates GitHub Release
   - Builds Docker images

4. **Verify release**:
   ```bash
   npm view ccjk@<version>
   docker pull ccjk/ccjk:<version>
   ```

## Troubleshooting

### Common Issues

**1. catalog: references in published package**
```bash
# Fix: Run before publishing
node scripts/fix-package-catalog.mjs
```

**2. Failing integration tests**
- Check service logs in Actions tab
- Verify database connections
- Review test output

**3. Docker build failures**
- Check multi-platform compatibility
- Verify Dockerfile syntax
- Review build logs

**4. Performance regression**
- Compare benchmark results
- Identify slow operations
- Optimize affected code

### Debug Mode

Enable debug logging:

```yaml
env:
  ACTIONS_STEP_DEBUG: true
  ACTIONS_RUNNER_DEBUG: true
```

## Monitoring

### Slack Notifications

Workflows notify on:
- Release publishes
- Deployment status
- Performance regression
- Security vulnerabilities

### Coverage Reports

View at:
- Codecov: https://codecov.io/gh/lu/ccjk-public
- GitHub PR comments
- Coverage badge in README

### Benchmark Results

View at:
- GitHub Action artifacts
- PR comments
- Benchmark action summary

## Maintenance

### Updating Actions

```bash
# Check for updates
npx npm-check-updates

# Update action versions
# Edit workflow files with new versions
```

### Cleaning Up

```bash
# Delete old workflow runs
gh run list --workflow=ci.yml --limit 100 | \
  grep "completed" | \
  xargs -I {} gh run delete {}
```

### Cost Optimization

- Use `cancel-in-progress: true` to reduce wasted runs
- Set appropriate artifact retention (7-30 days)
- Limit scheduled workflow frequency
- Use caching aggressively

## Best Practices

1. **Keep workflows fast**: < 5 minutes target
2. **Use caching**: pnpm, Docker layers
3. **Parallel execution**: Run independent jobs together
4. **Fail fast**: Early validation in pipeline
5. **Clear messaging**: Helpful error messages
6. **Security**: Limit secret access, use branches
7. **Monitoring**: Track performance trends
8. **Documentation**: Update this file with changes

## Additional Resources

- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Changesets Guide](https://github.com/changesets/changesets)
- [Docker Build Push Action](https://github.com/docker/build-push-action)
- [Codecov Documentation](https://docs.codecov.com/)
- [Benchmark Action](https://github.com/benchmark-action/github-action-benchmark)
