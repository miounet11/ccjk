---
name: pr-review
description: 全面的 PR 审查，包含安全、性能和代码质量检查
version: 1.0.0
author: CCJK
category: review
triggers:
  - /pr-review
  - /review-pr
  - /pr
use_when:
  - "用户想要审查拉取请求"
  - "PR 需要代码审查"
  - "合并请求审查"
  - "用户提到审查变更"
auto_activate: true
priority: 8
difficulty: intermediate
tags:
  - pr
  - review
  - git
  - code-quality
allowed-tools:
  - Bash(git *)
  - Read
  - Grep
  - Glob
  - LSP
context: fork
user-invocable: true
hooks:
  - type: SkillActivate
    command: echo "开始 PR 审查..."
  - type: SkillComplete
    command: echo "PR 审查完成"
---

# PR 审查技能

全面的拉取请求审查工作流，自动检查代码质量、安全性、性能和测试覆盖率。

## 工作流步骤

### 1. 变更分析

首先，分析 PR 变更：

```bash
# 获取当前分支和目标分支
git branch --show-current
git log --oneline origin/main..HEAD

# 获取变更文件
git diff --name-only origin/main...HEAD

# 获取详细的差异统计
git diff --stat origin/main...HEAD
```

**分析清单：**
- [ ] 识别所有修改的文件
- [ ] 分类变更（功能、修复、重构、文档）
- [ ] 检查破坏性变更
- [ ] 验证提交信息质量
- [ ] 检查合并冲突

### 2. 代码质量检查

审查所有变更文件的代码质量：

**对于每个变更文件：**

1. **使用 Read 工具读取文件**
2. **检查代码异味：**
   - 重复代码
   - 长函数（>50 行）
   - 复杂条件（>3 层）
   - 魔法数字/字符串
   - 不一致的命名约定

3. **验证最佳实践：**
   - 适当的错误处理
   - 输入验证
   - 日志记录的适当性
   - 注释质量
   - 代码文档

4. **检查 TypeScript/JavaScript 特定问题：**
   - 类型安全（TypeScript）
   - async/await 使用
   - Promise 处理
   - 潜在的内存泄漏
   - 正确的导入/导出

### 3. 安全审查

执行安全分析：

**安全清单：**
- [ ] 无硬编码的凭据或 API 密钥
- [ ] 日志中无敏感数据
- [ ] 适当的输入清理
- [ ] SQL 注入防护
- [ ] XSS 防护
- [ ] CSRF 防护
- [ ] 身份验证/授权检查
- [ ] 依赖项漏洞

**搜索常见安全问题：**

```bash
# 搜索潜在的密钥
git grep -i "password\|secret\|api_key\|token" -- '*.ts' '*.js' '*.json'

# 检查生产代码中的 console.log
git grep "console\\.log" -- 'src/**/*.ts' 'src/**/*.js'

# 查找 eval 或危险函数
git grep -E "eval\(|Function\(|setTimeout.*string|setInterval.*string"
```

### 4. 性能审查

分析性能影响：

**性能清单：**
- [ ] 无不必要的重新渲染（React）
- [ ] 高效的数据结构
- [ ] 适当的缓存策略
- [ ] 数据库查询优化
- [ ] 无 N+1 查询问题
- [ ] 适当的懒加载
- [ ] 打包大小影响
- [ ] 内存使用考虑

**检查性能反模式：**
- 循环中的同步操作
- 不必要的 API 调用
- 无分页的大数据处理
- 缺少索引（数据库）
- 低效算法（O(n²) 或更差）

### 5. 测试覆盖率

验证变更的测试覆盖率：

```bash
# 查找变更文件的测试文件
git diff --name-only origin/main...HEAD | grep -E '\.(test|spec)\.(ts|js)$'

# 检查新代码是否有相应的测试
# 对于每个变更的源文件，验证测试文件是否存在
```

**测试覆盖率清单：**
- [ ] 新函数的单元测试
- [ ] 新功能的集成测试
- [ ] 边界情况覆盖
- [ ] 错误处理测试
- [ ] Mock/Stub 使用的适当性
- [ ] 测试命名清晰度
- [ ] 断言质量

### 6. 架构与设计

审查架构决策：

**架构清单：**
- [ ] 遵循项目模式
- [ ] 适当的关注点分离
- [ ] SOLID 原则遵守
- [ ] DRY 原则（不要重复自己）
- [ ] 适当的抽象级别
- [ ] 依赖注入使用
- [ ] 模块耦合/内聚

### 7. 文档审查

检查文档质量：

**文档清单：**
- [ ] README 更新（如需要）
- [ ] API 文档
- [ ] 复杂逻辑的内联注释
- [ ] JSDoc/TSDoc 注释
- [ ] CHANGELOG 更新
- [ ] 迁移指南（破坏性变更）

## 输出格式

以以下结构化格式提供审查结果：

```markdown
# PR 审查摘要

## 概览
- **分支**: [分支名称]
- **目标**: [目标分支]
- **变更文件**: [数量]
- **新增行数**: [数量]
- **删除行数**: [数量]

## 变更摘要
[简要描述此 PR 的功能]

## 审查结果

### ✅ 优点
- [列出积极方面]
- [观察到的良好实践]
- [实现良好的功能]

### ⚠️ 发现的问题

#### 🔴 严重问题
- **[文件:行号]**: [描述]
  - **影响**: [说明]
  - **建议**: [如何修复]

#### 🟡 警告
- **[文件:行号]**: [描述]
  - **建议**: [改进建议]

#### 🔵 建议
- **[文件:行号]**: [描述]
  - **增强**: [可选改进]

### 安全分析
- **状态**: ✅ 通过 / ⚠️ 发现问题 / 🔴 严重
- **发现**: [列出安全问题（如有）]

### 性能分析
- **状态**: ✅ 良好 / ⚠️ 关注 / 🔴 问题
- **发现**: [列出性能问题（如有）]

### 测试覆盖率
- **状态**: ✅ 充分 / ⚠️ 不足 / 🔴 缺失
- **覆盖率**: [百分比（如可用）]
- **缺失测试**: [列出需要测试的区域]

### 代码质量评分
- **总体**: [10 分制评分]
- **可维护性**: [评分]
- **可读性**: [评分]
- **可测试性**: [评分]

## 建议

### 必须修复（合并前）
1. [严重问题 1]
2. [严重问题 2]

### 应该修复（高优先级）
1. [重要问题 1]
2. [重要问题 2]

### 可选改进（可选）
1. [增强 1]
2. [增强 2]

## 批准状态
- [ ] ✅ **已批准** - 准备合并
- [ ] ⚠️ **有意见批准** - 可以合并但需处理意见
- [ ] 🔴 **请求变更** - 合并前必须修复问题

## 附加说明
[任何其他观察或上下文]
```

## 最佳实践

1. **建设性**: 关注改进，而非批评
2. **具体**: 指出确切的文件和行号
3. **解释原因**: 不仅说明问题，还要解释影响
4. **提供解决方案**: 提供可操作的建议
5. **认可优秀工作**: 突出积极方面
6. **考虑上下文**: 理解项目约束和截止日期
7. **使用示例**: 在建议变更时展示更好的替代方案

## 常见审查模式

### 模式 1: 功能添加
- 验证功能完整性
- 检查功能标志
- 验证错误处理
- 确保向后兼容性

### 模式 2: Bug 修复
- 验证根本原因已解决
- 检查回归测试
- 验证修复不会引入新问题
- 审查相关代码区域

### 模式 3: 重构
- 确保行为未改变
- 验证测试覆盖率保持
- 检查性能影响
- 验证代码简化

### 模式 4: 依赖更新
- 审查变更日志
- 检查破坏性变更
- 验证兼容性
- 测试关键路径

## 与 CI/CD 集成

如果 CI/CD 结果可用，将其纳入：

```bash
# 检查 CI 状态
gh pr checks [PR-编号]

# 查看测试结果
gh pr view [PR-编号] --json statusCheckRollup
```

## 最终清单

完成审查前：

- [ ] 所有变更文件已审查
- [ ] 安全问题已解决
- [ ] 性能影响已考虑
- [ ] 测试覆盖率已验证
- [ ] 文档已检查
- [ ] 架构对齐已确认
- [ ] 破坏性变更已识别
- [ ] 批准状态已确定
- [ ] 可操作的反馈已提供
- [ ] 审查摘要已格式化

## 注意事项

- 使用 LSP 工具获取类型检查和 linting 结果
- 利用 Grep 在代码库中进行模式匹配
- 使用 Glob 查找相关文件
- 完整读取文件以获取上下文
- 考虑 CLAUDE.md 中的项目特定指南
- 根据 PR 大小和复杂性调整审查深度
